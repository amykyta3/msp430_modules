<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>A Library of MSP430 C Code: USB CDC Example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">A Library of MSP430 C Code
   </div>
   <div id="projectbrief">Collection of peripheral drivers, component drivers, utilities, and other commonly used embedded code.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">USB CDC Example </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#SEC_EX_USB1">1. Introduction</a></li>
<li class="level1"><a href="#SEC_EX_USB2">2. Description</a><ul><li class="level2"><a href="#SEC_EX_USB2_1">2.1 The main.c File</a><ul><li class="level3"><a href="#SEC_EX_USB2_1_1">2.1.1 The main() Routine</a></li>
<li class="level3"><a href="#SEC_EX_USB2_1_2">2.1.2 Event Handlers</a></li>
</ul>
</li>
<li class="level2"><a href="#SEC_EX_USB2_2">2.2 CLI Commands</a></li>
<li class="level2"><a href="#SEC_EX_USB2_3">2.3 USB Configuration</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>Communicate to the MSP430 using a command-line interface using the 5xx/6xx-series USB</p>
<h1><a class="anchor" id="SEC_EX_USB1"></a>
1. Introduction</h1>
<dl class="section user"><dt></dt><dd>This example demonstrates a USB CDC interface (Virtual COM port in Windows-speak) using the MSP430 5xx/6xx-series USB peripheral. All text IO is handled using the <a class="el" href="group___m_o_d___c_l_i.html">Command Line Interface</a> module to implement several simple commands.</dd></dl>
<dl class="section user"><dt></dt><dd>Any MSP430 development board that uses a 5xx/6xx series processor with USB will work. This includes TI's <a href="http://www.ti.com/tool/msp-exp430f5529lp">MSP430F5529 LaunchPad</a>.</dd></dl>
<dl class="section user"><dt></dt><dd>This example assumes there is a 4 MHz crystal oscillator attached to the appropriate XT2 pins. If using something other than the MSP430F5529, only the port initialization for the XT2 pins will need to be changed.</dd></dl>
<dl class="section user"><dt></dt><dd>This example demonstrates the use of the following modules:<ul>
<li><a class="el" href="group___m_o_d___c_l_o_c_k_s_y_s.html">Clock System</a></li>
<li><a class="el" href="group___m_o_d___e_v_e_n_t___q_u_e_u_e.html">Event Queue</a> which also uses <a class="el" href="group___m_o_d___f_i_f_o.html">FIFO Ring Buffer</a> internally.</li>
<li><a class="el" href="group___m_o_d___u_s_b.html">USB API</a> which also uses <a class="el" href="group___m_o_d___s_l_e_e_p.html">Sleep</a> internally.</li>
<li><a class="el" href="group___m_o_d___c_l_i.html">Command Line Interface</a></li>
</ul>
</dd></dl>
<hr/>
 <h1><a class="anchor" id="SEC_EX_USB2"></a>
2. Description</h1>
<h2><a class="anchor" id="SEC_EX_USB2_1"></a>
2.1 The main.c File</h2>
<h3><a class="anchor" id="SEC_EX_USB2_1_1"></a>
2.1.1 The main() Routine</h3>
<dl class="section user"><dt></dt><dd>As always, our program's entry point is main() where several things are initialized. Since the USB's PLL requires a stable clock source, the XT2 pins are set to their special function. All of the module init functions are called in order of their dependence <div class="fragment"><div class="line">    WDTCTL = WDTPW + WDTHOLD; <span class="comment">// Stop the Watchdog Timer</span></div><div class="line">    __disable_interrupt(); <span class="comment">// Disable Interrupts</span></div><div class="line">    </div><div class="line">    P5SEL |= 0x0C;  <span class="comment">//enable XT2 pins for F5529</span></div><div class="line">    </div><div class="line">    <a class="code" href="group___m_o_d___c_l_o_c_k_s_y_s.html#ga78ab77b57cf2e00089f0a3a22508524c">clock_init</a>();</div><div class="line">    <a class="code" href="group___m_o_d___e_v_e_n_t___q_u_e_u_e.html#ga703aee6d18b09a8b0e7fa762e6024594">event_init</a>();</div><div class="line">    <a class="code" href="group___m_o_d___u_s_b.html#ga3cffb725fc7ab389006f59edabf1271c">USB_init</a>();</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>Some further initialization of the USB API is required. Since we want the program to react to any characters received, the corresponding event is enabled. We also want to connect and disconnect the USB every time the cable is inserted and removed. This is handled using events. <div class="fragment"><div class="line">    <a class="code" href="group___m_o_d___u_s_b.html#gaa4a5b2a9dfa5fd1f2220cd44d6377590">USB_setEnabledEvents</a>(<a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#ga921ce1404c8ef1ce6de99d82e9c13db8">USBEV_DATARECV_EN</a> | <a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#gad714cd4599d6148717337744c1cea7ed">USBEV_VBUSON_EN</a> | <a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#ga484c0a3393d68944194da8568156c364">USBEV_VBUSOFF_EN</a>);</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>At this point the USB interface has been initialized. In the special case that the USB cable is already inserted into the host, we want to enable the connection so the host can enumerate it: <div class="fragment"><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___m_o_d___u_s_b.html#gaad1cf194f68fba1fec1fdf2048a889f2">USB_connectionInfo</a>() &amp; USB_VBUS_PRESENT){</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___m_o_d___u_s_b.html#gadc4a26efc31297e05af375a24ec03e41">USB_enable</a>() == 0){</div><div class="line">            <a class="code" href="group___m_o_d___u_s_b.html#ga300dfedd75bf64ca52ba3ae3b144aae9">USB_reset</a>();</div><div class="line">            <a class="code" href="group___m_o_d___u_s_b.html#gae902ebfe126d9bd478741c0ed233256b">USB_connect</a>();</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>Finally, the event-handler is started: <div class="fragment"><div class="line">    __enable_interrupt();</div><div class="line">    <a class="code" href="group___m_o_d___e_v_e_n_t___q_u_e_u_e.html#gaf859b36463aafa4644f13fc892998a27">event_StartHandler</a>();</div></div><!-- fragment --></dd></dl>
<h3><a class="anchor" id="SEC_EX_USB2_1_2"></a>
2.1.2 Event Handlers</h3>
<dl class="section user"><dt></dt><dd>The previous section mentioned several events that are generated. Just below the main() routine, they are handled.</dd></dl>
<dl class="section user"><dt></dt><dd>First, the USB API has been configured to generate events when the USB +5v is detected or lost. In these cases, we want to automatically connect and disconnect the USB device: <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___m_o_d___u_s_b.html#ga8813ef3719a51398915fc2857ea078fc">onUSB_Event</a>(<a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#gab293142da15a171005a56a1026023939">USB_EVENT_t</a> event){</div><div class="line">    <span class="keywordflow">switch</span>(event){</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#ggab293142da15a171005a56a1026023939aded3cb5370691dfae3d4de11e3cde412">USBEV_VBUSON</a>:</div><div class="line">            <span class="comment">// User plugged the USB cable in</span></div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___m_o_d___u_s_b.html#gadc4a26efc31297e05af375a24ec03e41">USB_enable</a>() == 0){</div><div class="line">                <a class="code" href="group___m_o_d___u_s_b.html#ga300dfedd75bf64ca52ba3ae3b144aae9">USB_reset</a>();</div><div class="line">                <a class="code" href="group___m_o_d___u_s_b.html#gae902ebfe126d9bd478741c0ed233256b">USB_connect</a>();</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#ggab293142da15a171005a56a1026023939a3af52bcfcfb91c0d01eb38e97d094c4c">USBEV_VBUSOFF</a>:</div><div class="line">            <span class="comment">// User unplugged the USB cable</span></div><div class="line">            <a class="code" href="group___m_o_d___u_s_b.html#ga52d31b936b31e9d3ad2c360d0ef661d3">USB_disconnect</a>();</div><div class="line">            <a class="code" href="group___m_o_d___u_s_b.html#ga680e03643ad44bd7b34cecef16edbb8f">USB_disable</a>();</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>The other event that was enabled was the CDC Data Received event. Here we handle the incoming data. In this example, the data is read from the USB API and then fed into the <a class="el" href="group___m_o_d___c_l_i.html">Command Line Interface</a> module's character processor. This automates the process of parsing incoming text commands and then reacting to them. <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___m_o_d___u_s_b.html#ga63d4c29a898c4a0d59ca5949d5f7e174">onUSB_InterfaceEvent</a>(<a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#gab293142da15a171005a56a1026023939">USB_EVENT_t</a> event,uint8_t intfNum){</div><div class="line">    <span class="keywordflow">if</span>(event == <a class="code" href="group___u_s_b___d_e_f_i_n_i_t_i_o_n_s.html#ggab293142da15a171005a56a1026023939a6bd44f6fa1c3910aff7f9bfcdd54b017">USBEV_CDC_DATARECV</a>){</div><div class="line">        <span class="comment">// pass any characters recvd into the CLI handler</span></div><div class="line">        <span class="keywordtype">char</span> strbuf[128];</div><div class="line">        uint16_t n, i;</div><div class="line">        </div><div class="line">        n = <a class="code" href="group___m_o_d___u_s_b.html#ga1bc70f009c4bc720aaa1a04a50a55b43">USB_cdcRecvAvailable</a>(strbuf,<span class="keyword">sizeof</span>(strbuf),0);</div><div class="line"></div><div class="line">        <span class="keywordflow">for</span>(i=0;i&lt;n;i++){</div><div class="line">            <a class="code" href="group___m_o_d___c_l_i.html#gaa7f099deb2473fd6e8da15d0fd166b57">cli_process_char</a>(strbuf[i]);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></dd></dl>
<h2><a class="anchor" id="SEC_EX_USB2_2"></a>
2.2 CLI Commands</h2>
<dl class="section user"><dt></dt><dd>The whole purpose of the CLI module is to take a stream of incoming characters, parse them, and call the appropriate command function. This example uses a USB CDC interface but it can just as easily be adapted to use UART or something else.</dd></dl>
<dl class="section user"><dt></dt><dd>Each command mnemonic is easily linked to the corresponding command function in the config/cli_commands.h file. This is done using a command table. The header file must also include the function prototypes for the command functions.  <div class="fragment"><div class="line"><span class="preprocessor">#define CMDTABLE    {&quot;bye&quot;      , cmdBye      },\</span></div><div class="line"><span class="preprocessor">                    {&quot;help&quot;     , cmdHelp     },\</span></div><div class="line"><span class="preprocessor">                    {&quot;hi&quot;       , cmdHello    },\</span></div><div class="line"><span class="preprocessor">                    {&quot;listargs&quot; , cmdListArgs }</span></div><div class="line"></div><div class="line"><span class="comment">// Custom command function prototypes:</span></div><div class="line"><span class="keywordtype">int</span> cmdBye(uint16_t argc, <span class="keywordtype">char</span> *argv[]);</div><div class="line"><span class="keywordtype">int</span> cmdHelp(uint16_t argc, <span class="keywordtype">char</span> *argv[]);</div><div class="line"><span class="keywordtype">int</span> cmdHello(uint16_t argc, <span class="keywordtype">char</span> *argv[]);</div><div class="line"><span class="keywordtype">int</span> cmdListArgs(uint16_t argc, <span class="keywordtype">char</span> *argv[]);</div></div><!-- fragment --></dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>Because of how the command-lookup works, the table's command mnemonics <em>must</em> be in ASCII alphabetical order! That means a command word starting with a lower-case 'a' comes <em>after</em> a command that starts with an upper-case 'Z'. See the <a href="http://en.wikipedia.org/wiki/Ascii#ASCII_printable_characters">ASCII wiki page</a> for more details.</dd></dl>
<dl class="section user"><dt></dt><dd>So, in this table we linked up three commands:<ul>
<li>The text "listargs" will execute the cmdListArgs() function</li>
<li>The text "bye" will execute the cmdBye() function</li>
<li>The text "hi" will execute the cmdHello() function</li>
<li>The text "help" will execute the cmdHelp() function The implementation of these commands can be found in config/cli_commands.c </li>
</ul>
</dd></dl>
<dl class="section user"><dt></dt><dd>For the "listargs" function, the program will simply echo back a list of arguments passed to the command. Note that each command function receives an argc and argv argument. These can be used exactly the same way you would when writing a C main() routine on a PC. <div class="fragment"><div class="line"><span class="keywordtype">int</span> cmdListArgs(uint16_t argc, <span class="keywordtype">char</span> *argv[]){</div><div class="line">    cli_puts(<span class="stringliteral">&quot;Argument List:\r\n&quot;</span>);</div><div class="line">    <span class="keywordtype">int</span> i;</div><div class="line">    <span class="keywordflow">for</span>(i=0;i&lt;argc;i++){</div><div class="line">        cli_putc(<span class="charliteral">&#39;[&#39;</span>);</div><div class="line">        cli_puts(argv[i]);</div><div class="line">        cli_puts(<span class="stringliteral">&quot;]\r\n&quot;</span>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span>(0);</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>You may notice that all text output is done using the cli_putc() and cli_puts() functions. These functions must be defined for the USB interface and can be found in the same cli_commands.c file.  <div class="fragment"><div class="line"><span class="keywordtype">void</span> cli_puts(<span class="keywordtype">char</span> *str){</div><div class="line">    <a class="code" href="group___m_o_d___u_s_b.html#ga3608068e6ee1602c61ce2164b4d1d121">USB_cdcSend</a>(str,strlen(str),0,0);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> cli_putc(<span class="keywordtype">char</span> chr){</div><div class="line">    <a class="code" href="group___m_o_d___u_s_b.html#ga3608068e6ee1602c61ce2164b4d1d121">USB_cdcSend</a>(&amp;chr,1,0,0);</div><div class="line">}</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd>Lastly, a couple more abstraction functions must be defined: <div class="fragment"><div class="line"><span class="keywordtype">void</span> cli_print_prompt(<span class="keywordtype">void</span>){</div><div class="line">    cli_putc(<span class="charliteral">&#39;&gt;&#39;</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> cli_print_error(<span class="keywordtype">int</span> error){</div><div class="line">    </div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> cli_print_notfound(<span class="keywordtype">char</span> *strcmd){</div><div class="line">    cli_puts(<span class="stringliteral">&quot;Command &#39;&quot;</span>);</div><div class="line">    cli_puts(strcmd);</div><div class="line">    cli_puts(<span class="stringliteral">&quot;&#39; not found\r\n&quot;</span>);</div><div class="line">}</div></div><!-- fragment --></dd></dl>
<dl class="section user"><dt></dt><dd><ul>
<li>cli_print_prompt() defines what (if anything) gets echoed back to the host as a prompt for a new command.</li>
<li>cli_print_error() allows you to output something if a command returns a non-zero response. This example does not print anything in this case.</li>
<li>cli_print_notfound() lets you customize the message if a command was not found in the command table.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="SEC_EX_USB2_3"></a>
2.3 USB Configuration</h2>
<dl class="section user"><dt></dt><dd>The files found in the config/USB_config folder are generated using TI's <a href="http://www.ti.com/tool/msp430usbdevpack">MSP430 USB Descriptor Tool</a> </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Feb 12 2018 21:23:53 for A Library of MSP430 C Code by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
